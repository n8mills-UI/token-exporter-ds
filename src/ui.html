<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Token Exporter v4.0.6</title>
    
    <!-- External Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lucide@latest/dist/umd/lucide.js"></script>
    
    <!-- Final v4.0.6 Design System Styles (Optimized for Plugin) -->
    <style>
        /*
        ==========================================================================
        Token Exporter Design System v4.0.6 | INLINE & OPTIMIZED FOR FIGMA PLUGIN
        ==========================================================================
        */

        :root {
            --brand-primary-lime: #D2FF37;
            --brand-secondary-yellow: #EEFF00;
            --brand-text-dark: #1E1E1E;
            --brand-gradient-lime: linear-gradient(180deg, var(--brand-primary-lime) 0%, var(--brand-secondary-yellow) 100%);
            --category-color-cyan: #00D1FF;
            --category-color-purple: #B48CFF;
            --category-color-orange: #FFB86C;
            --category-color-pink: #FF74BC;
            --gray-9: #1e1e1e;
            --gray-8: #2a2a2a;
            --gray-7: #3a3a3a;
            --gray-6: #444444;
            --gray-5: #666666;
            --gray-3: #a0a0a0;
            --gray-2: #cccccc;
            --gray-0: #ffffff;
            --color-text-default: var(--gray-0);
            --color-text-secondary: var(--gray-2);
            --color-text-muted: var(--gray-3);
            --color-text-on-brand: var(--brand-text-dark);
            --color-text-error: #ff6b6b;
            --color-background-primary: var(--gray-9);
            --color-background-secondary: var(--gray-8);
            --color-background-tertiary: var(--gray-7);
            --color-background-disabled: #333333;
            --color-border-default: var(--gray-6);
            --color-border-interactive-focus: var(--brand-primary-lime);
            --font-sans: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            --size-1: 0.25rem; --size-2: 0.5rem; --size-3: 0.75rem; --size-4: 1rem;
            --size-5: 1.25rem; --size-6: 1.5rem; --size-8: 2rem; --size-9: 2.25rem;
            --size-10: 2.5rem; --size-12: 3.5rem;
            --radius-1: 0.125rem; --radius-2: 0.375rem; --radius-3: 0.5rem;
            --radius-4: 1rem; --radius-round: 9999px;
            --font-size-00: .75rem; --font-size-0: .875rem; --font-size-1: 1rem;
            --font-size-2: 1.125rem; --font-size-3: 1.25rem; --font-size-5: 2rem;
            --font-size-7: 3rem;
            --font-weight-4: 400; --font-weight-5: 500; --font-weight-6: 600;
            --font-weight-7: 700;
            --font-lineheight-3: 1.5;
            --font-letterspacing-2: .05em;
            --gradient-7: linear-gradient(135deg, var(--gray-9), var(--gray-8));
        }
        
        html { overflow: hidden; }
        body { color: var(--color-text-default); background-color: var(--color-background-primary); font-family: var(--font-sans); font-size: 14px; line-height: 1.5; margin: 0; padding: 0; height: 100vh; display: flex; flex-direction: column; }
        * { box-sizing: border-box; }
        .text-heading-xl { font-size: var(--font-size-7); font-weight: var(--font-weight-7); }
        .text-heading-lg { font-size: var(--font-size-5); font-weight: var(--font-weight-6); }
        .text-heading-md { font-size: var(--font-size-3); font-weight: var(--font-weight-6); }
        .text-body-lg { font-size: var(--font-size-2); font-weight: var(--font-weight-5); }
        .text-body-md { font-size: var(--font-size-1); font-weight: var(--font-weight-4); }
        .text-label { font-size: var(--font-size-0); font-weight: var(--font-weight-6); text-transform: uppercase; letter-spacing: var(--font-letterspacing-2); }
        .text-caption { font-size: var(--font-size-00); font-weight: var(--font-weight-5); }
        main { display: flex; flex-direction: column; flex-grow: 1; min-height: 0; }
        .content-wrapper { padding: var(--size-3); flex-grow: 1; overflow-y: auto; }
        .content-wrapper::-webkit-scrollbar { width: var(--size-2); }
        .content-wrapper::-webkit-scrollbar-track { background-color: transparent; }
        .content-wrapper::-webkit-scrollbar-thumb { background-color: var(--gray-6); border-radius: var(--radius-1); }
        .card { background: var(--color-background-secondary); border-radius: var(--radius-3); padding: var(--size-3); margin-bottom: var(--size-2); border: 1px solid var(--color-border-default); }
        .token-summary { text-align: center; padding: var(--size-6) var(--size-4); }
        .token-summary .token-count-total { color: var(--brand-primary-lime); margin-bottom: var(--size-1); }
        .token-summary .token-label { color: var(--color-text-muted); margin-bottom: var(--size-4); }
        .token-breakdown { display: grid; grid-template-columns: repeat(4, 1fr); gap: var(--size-2); border-top: 1px solid var(--gray-8); padding-top: var(--size-4); }
        .token-type-stat { text-align: center; transition: all 0.2s ease-in-out; cursor: default; padding: var(--size-2); border-radius: var(--radius-2); background: var(--color-background-tertiary); border: 1px solid transparent; min-height: 60px; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .token-type-stat .icon { margin-bottom: var(--size-1); transition: transform 0.2s ease-in-out; display: block; }
        .token-type-stat .count { font-size: var(--font-size-2); font-weight: var(--font-weight-6); margin-bottom: var(--size-1); }
        .token-type-stat.color .icon { color: var(--category-color-cyan); }
        .token-type-stat.text .icon { color: var(--category-color-purple); }
        .token-type-stat.states .icon { color: var(--category-color-pink); }
        .token-type-stat.number .icon { color: var(--category-color-orange); }
        .advanced-mode .token-type-stat { cursor: pointer; }
        .advanced-mode .token-type-stat:hover { background: var(--color-background-tertiary); border-color: var(--gray-5); }
        .advanced-mode .token-type-stat.active { background: rgba(210, 255, 55, 0.1); border-color: var(--brand-primary-lime); }
        .advanced-mode .token-type-stat.disabled { opacity: 0.4; cursor: not-allowed; }
        .section-title { margin-bottom: var(--size-3); display: flex; align-items: center; gap: var(--size-2); }
        .section-title .lucide { color: var(--brand-primary-lime); }
        .subtitle { color: var(--color-text-muted); margin-bottom: var(--size-4); }
        .format-select-wrapper { position: relative; margin-bottom: var(--size-4); }
        .format-select { width: 100%; padding: var(--size-3) var(--size-8) var(--size-3) var(--size-4); background: var(--color-background-tertiary); border: 1px solid var(--color-border-default); border-radius: var(--radius-2); font-weight: var(--font-weight-5); cursor: pointer; appearance: none; transition: all 0.2s ease-in-out; color: var(--color-text-default); font-family: inherit; }
        .format-select:hover { background: var(--color-background-tertiary); border-color: var(--brand-primary-lime); }
        .format-select-wrapper::after { content: ''; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%23a0a0a0' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='m6 9 6 6 6-6'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: center; width: 1em; height: 1em; position: absolute; right: var(--size-4); top: 50%; transform: translateY(-50%); pointer-events: none; }
        .btn { width: 100%; padding: var(--size-2) var(--size-3); border-radius: var(--radius-2); font-weight: var(--font-weight-6); cursor: pointer; transition: all 0.2s ease-in-out; border: none; display: flex; align-items: center; justify-content: center; gap: var(--size-2); position: relative; overflow: hidden; font-family: inherit; font-size: var(--font-size-1); }
        .btn.primary { background: var(--brand-gradient-lime); color: var(--color-text-on-brand); box-shadow: 0 4px 15px rgba(210, 255, 55, 0.15); }
        .btn.primary:hover:not(:disabled) { filter: brightness(1.1); transform: translateY(-1px); box-shadow: 0 6px 20px rgba(210, 255, 55, 0.25); }
        .btn.secondary { background: var(--color-background-secondary); border: 1px solid var(--color-border-default); color: var(--color-text-default); }
        .btn.secondary:hover:not(:disabled) { background: var(--color-background-tertiary); border-color: var(--gray-5); transform: translateY(-1px); }
        .btn:disabled { background: var(--color-background-disabled); color: var(--gray-5); cursor: not-allowed; opacity: 0.6; }
        .collection-list { display: flex; flex-direction: column; gap: var(--size-2); max-height: 300px; overflow-y: auto; padding-right: var(--size-1); }
        .collection-item { padding: var(--size-2); background: var(--color-background-secondary); border: 1px solid var(--color-border-default); border-radius: var(--radius-2); cursor: pointer; transition: all 0.2s ease-in-out; display: flex; align-items: center; gap: var(--size-3); min-height: 48px; }
        .collection-item:hover { background: var(--color-background-tertiary); border-color: var(--gray-5); }
        .collection-item.selected { background: rgba(210, 255, 55, 0.05); border-color: var(--brand-primary-lime); }
        .collection-checkbox { width: 14px; height: 14px; border: 2px solid var(--color-border-default); border-radius: var(--radius-1); position: relative; transition: all 0.2s ease-in-out; flex-shrink: 0; pointer-events: none; }
        .collection-item.selected .collection-checkbox { background: var(--brand-gradient-lime); border-color: var(--brand-primary-lime); }
        .collection-item.selected .collection-checkbox::after { content: ''; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%231E1E1E' stroke-width='3' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M20 6 9 17l-5-5'/%3E%3C/svg%3E"); width: 10px; height: 10px; background-size: contain; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); }
        .collection-info { flex-grow: 1; min-width: 0; display: flex; flex-direction: column; justify-content: center; }
        .collection-name { font-weight: var(--font-weight-5); margin-bottom: var(--size-1); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .collection-pills { display: flex; gap: var(--size-1); flex-wrap: wrap; margin-top: var(--size-1); }
        .collection-pill { display: inline-flex; align-items: center; gap: var(--size-1); padding: var(--size-1); border-radius: var(--radius-1); font-size: var(--font-size-00); font-weight: var(--font-weight-5); }
        .collection-pill.color { background: rgba(0, 209, 255, 0.1); color: var(--category-color-cyan); }
        .collection-pill.text { background: rgba(180, 140, 255, 0.1); color: var(--category-color-purple); }
        .collection-pill.number { background: rgba(255, 184, 108, 0.1); color: var(--category-color-orange); }
        .collection-pill.states { background: rgba(255, 116, 188, 0.1); color: var(--category-color-pink); }
        .collection-pill.disabled { opacity: 0.5; }
        .progress-overlay { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.8); display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 1000; padding: var(--size-6); backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px); }
        .progress-container { background: var(--color-background-secondary); border: 1px solid var(--color-border-default); border-radius: var(--radius-3); padding: var(--size-4); text-align: center; max-width: 280px; width: 90%; }
        .success-icon { color: var(--brand-primary-lime); margin-bottom: var(--size-3); filter: drop-shadow(0 0 15px rgba(210, 255, 55, 0.4)); animation: successPop 0.6s ease-out; }
        .success-title { margin-bottom: var(--size-2); }
        .success-subtitle { color: var(--color-text-secondary); margin-bottom: var(--size-5); }
        .action-buttons { display: flex; gap: var(--size-3); flex-direction: column; }
        .empty-state { background: var(--gradient-7); border: 1px dashed rgba(210, 255, 55, 0.2); border-radius: var(--radius-3); padding: var(--size-8) var(--size-4); text-align: center; display: flex; flex-direction: column; align-items: center; gap: var(--size-4); min-height: 240px; justify-content: center; }
        .empty-state-icon { width: var(--size-10); height: var(--size-10); background: rgba(210, 255, 55, 0.1); border-radius: var(--radius-round); display: flex; align-items: center; justify-content: center; color: var(--brand-primary-lime); margin-bottom: var(--size-2); }
        .empty-state-title { font-weight: var(--font-weight-5); margin-bottom: var(--size-1); }
        .empty-state-subtitle { color: var(--color-text-secondary); max-width: 280px; line-height: var(--font-lineheight-3); }
        .empty-state-action { color: var(--brand-primary-lime); text-decoration: none; font-weight: var(--font-weight-5); display: inline-flex; align-items: center; gap: var(--size-2); transition: all 0.2s ease-in-out; padding: var(--size-2) var(--size-3); border-radius: var(--radius-2); border: 1px solid transparent; }
        .empty-state-action:hover { background: rgba(210, 255, 55, 0.1); border-color: var(--brand-primary-lime); transform: translateY(-1px); }
        .skeleton-container { display: flex; flex-direction: column; gap: var(--size-3); padding: var(--size-3); }
        .skeleton-item { height: 60px; background: var(--gray-8); border-radius: var(--radius-3); position: relative; overflow: hidden; }
        .skeleton-item.small { height: 40px; }
        .skeleton-item:first-child { height: 180px; }
        .skeleton-pulse { background: var(--gray-7); animation: skeleton-pulse 2s ease-in-out infinite; }
        @keyframes skeleton-pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
        .about-modal { position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.85); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); z-index: 1001; display: none; align-items: center; justify-content: center; padding: var(--size-4); transition: all 0.3s ease-in-out; }
        .about-modal.show { display: flex; }
        .about-content { background: var(--color-background-secondary); border: 1px solid var(--color-border-default); border-radius: var(--radius-4); padding: var(--size-4); max-width: 280px; width: 90%; text-align: center; position: relative; display: flex; flex-direction: column; gap: var(--size-4); }
        .about-close { position: absolute; top: var(--size-2); right: var(--size-2); background: transparent; border: none; color: var(--color-text-secondary); cursor: pointer; padding: var(--size-2); border-radius: var(--radius-1); transition: all 0.2s ease-in-out; display: flex; align-items: center; justify-content: center; width: var(--size-8); height: var(--size-8); }
        .about-close:hover { background: var(--color-background-tertiary); }
        .about-avatar { width: var(--size-12); height: var(--size-12); border-radius: var(--radius-round); margin: 0 auto; background-size: cover; background-position: center; border: 3px solid var(--brand-primary-lime); background-color: var(--gray-7); background-image: url('https://res.cloudinary.com/dbmvymdp1/image/upload/v1751613219/nate_mills_nizmxp.png'); }
        .about-header { display: flex; flex-direction: column; gap: var(--size-1); padding-bottom: var(--size-3); margin-bottom: var(--size-3); border-bottom: 1px solid var(--color-border-default); }
        .about-links { display: flex; justify-content: center; gap: var(--size-2); }
        .about-link { display: flex; align-items: center; justify-content: center; width: var(--size-9); height: var(--size-9); background: var(--color-background-tertiary); border-radius: var(--radius-2); color: var(--color-text-secondary); text-decoration: none; transition: all 0.2s ease-in-out; }
        .about-link:hover { background: var(--brand-primary-lime); color: var(--brand-text-dark); transform: translateY(-2px); }
        .about-tagline { color: var(--color-text-muted); font-size: var(--font-size-00); }
        .heart { color: var(--category-color-pink); animation: heartbeat 1.5s ease-in-out infinite; }
        .advanced-toggle { text-align: center; margin-top: var(--size-3); }
        .advanced-link { color: var(--color-text-muted); text-decoration: none; font-weight: var(--font-weight-5); transition: color 0.2s ease-in-out; display: inline-flex; align-items: center; gap: var(--size-1); }
        .advanced-link:hover { color: var(--brand-primary-lime); }
        .footer-section { text-align: center; line-height: 1.4; padding: var(--size-3); border-top: 1px solid var(--color-border-default); margin-top: auto; }
        .footer-section a { color: var(--color-text-muted); text-decoration: none; transition: all 0.2s ease-in-out; }
        .footer-section a:hover { color: var(--brand-primary-lime); }
        .search-input { width: 100%; padding: var(--size-2) var(--size-3) var(--size-2) var(--size-8); background: var(--color-background-tertiary); border: 1px solid var(--color-border-default); border-radius: var(--radius-2); font-size: var(--font-size-1); transition: all 0.2s ease-in-out; color: var(--color-text-default); margin-bottom: var(--size-3); }
        .search-wrapper { position: relative; }
        .search-wrapper .lucide-search { position: absolute; left: var(--size-3); top: 50%; transform: translateY(-50%); color: var(--color-text-muted); pointer-events: none; }
        @keyframes successPop { 0% { transform: scale(0) rotate(-180deg); opacity: 0; } 70% { transform: scale(1.1) rotate(10deg); opacity: 1; } 100% { transform: scale(1) rotate(0deg); opacity: 1; } }
        @keyframes heartbeat { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
    </style>
</head>
<body>
    <main>
        <!-- This wrapper contains the static HTML skeleton -->
        <div class="content-wrapper" id="content-wrapper">
            
            <!-- Loading State (Visible by default) -->
            <div class="skeleton-container" id="skeleton-loader">
                <div class="skeleton-item skeleton-pulse"></div>
                <div class="skeleton-item skeleton-pulse small"></div>
                <div class="skeleton-item skeleton-pulse small"></div>
            </div>

            <!-- Empty State (Hidden by default) -->
            <div class="empty-state" id="empty-state" style="display: none;">
                <div class="empty-state-icon"><i data-lucide="package"></i></div>
                <div>
                    <div class="text-heading-lg empty-state-title">Let's build something!</div>
                    <div class="text-body-md empty-state-subtitle">Turn your colors, text styles, and spacing into code-ready tokens.</div>
                </div>
                <button class="btn primary empty-state-action" style="width: auto;" aria-label="Navigate to create variables in Figma">
                    Create variables <i data-lucide="arrow-right" style="margin-left: var(--size-2);"></i>
                </button>
            </div>

            <!-- Main UI (Hidden by default) -->
            <div id="main-ui" style="display: none;">
                <div class="card token-summary" id="token-summary-card">
                    <!-- JS will populate this -->
                </div>
                <div class="card export-section" id="export-card">
                    <!-- JS will populate this -->
                </div>
                <div class="card collections-section" id="collections-card" style="display: none;">
                    <!-- JS will populate this -->
                </div>
                <div class="advanced-toggle" id="advanced-toggle-container">
                    <!-- JS will populate this -->
                </div>
            </div>
        </div>

        <!-- Static Footer -->
        <div class="footer-section">
            <a href="#" id="about-link" class="text-caption">
                created with <span class="heart">❤️</span> by nate mills
            </a>
        </div>
    </main>

    <!-- Static Modals -->
    <div class="about-modal" id="about-modal">
        <div class="about-content">
            <button class="about-close" aria-label="Close about modal"> <i data-lucide="x"></i> </button>
            <div class="about-avatar"></div>
            <div class="about-header">
                <h2 class="text-heading-md">NATE MILLS</h2>
                <div class="text-body-lg" style="color: var(--color-text-secondary);">Senior UI Designer</div>
            </div>
            <p class="text-body-md" style="color: var(--color-text-secondary);">Building accessible design systems that scale.</p>
            <div class="about-links">
                <a href="#" class="about-link" data-url="https://natemills.me" title="Portfolio"><i data-lucide="briefcase"></i></a>
                <a href="#" class="about-link" data-url="https://www.linkedin.com/in/millsdesign/" title="LinkedIn"><i data-lucide="linkedin"></i></a>
                <a href="#" class="about-link" data-url="https://www.figma.com/@mills" title="Figma"><i data-lucide="figma"></i></a>
                <a href="#" class="about-link" data-url="mailto:nate@natemills.me" title="Email">
                    <i data-lucide="mail"></i>
                </a>
            </div>
            <div class="text-label about-tagline"> MADE WITH <span class="heart">❤️</span> FOR THE DESIGN COMMUNITY </div>
        </div>
    </div>
    
    <div class="progress-overlay" id="progress-overlay"></div>

    <script>
        // --- STATE & CONFIG ---
        const appState = {
            mode: 'simple',
            collections: [],
            selectedCollections: new Set(),
            selectedFormat: 'css',
            selectedTokenTypes: new Set(['color', 'text', 'number', 'states']),
            globalTokenCounts: { color: 0, text: 0, states: 0, number: 0 },
            searchTerm: '',
        };

        // --- DOM Elements ---
        const DOMElements = {
            skeletonLoader: document.getElementById('skeleton-loader'),
            emptyState: document.getElementById('empty-state'),
            mainUI: document.getElementById('main-ui'),
            tokenSummaryCard: document.getElementById('token-summary-card'),
            exportCard: document.getElementById('export-card'),
            collectionsCard: document.getElementById('collections-card'),
            advancedToggleContainer: document.getElementById('advanced-toggle-container'),
            aboutModal: document.getElementById('about-modal'),
            progressOverlay: document.getElementById('progress-overlay'),
            aboutLink: document.getElementById('about-link'),
        };

        // --- UTILITIES ---
        const openUrl = (url) => parent.postMessage({ pluginMessage: { type: 'open-url', url } }, '*');
        const debounce = (func, delay) => {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), delay);
            };
        };
        const renderIcons = () => {
            try {
                if (window.lucide) window.lucide.createIcons();
            } catch (error) {
                console.error("Lucide icon rendering failed:", error);
            }
        };

        // --- UI UPDATE ("HYDRATION") FUNCTIONS ---
        function updateUI() {
            DOMElements.mainUI.classList.toggle('advanced-mode', appState.mode === 'advanced');
            updateTokenSummary();
            updateExportCard();
            updateCollectionsCard();
            updateToggleContainer();
            renderIcons();
            attachDynamicEventListeners();
        }

        function updateTokenSummary() {
            const totalTokens = Object.values(appState.globalTokenCounts).reduce((s, c) => s + c, 0);
            const selectedCount = appState.mode === 'simple' ? totalTokens : appState.collections.reduce((count, col) => {
                if (!appState.selectedCollections.has(col.id)) return count;
                return count + Object.entries(col.counts).reduce((subCount, [type, num]) => appState.selectedTokenTypes.has(type) ? subCount + num : subCount, 0);
            }, 0);

            DOMElements.tokenSummaryCard.querySelector('.token-count-total').textContent = selectedCount;
            DOMElements.tokenSummaryCard.querySelector('.token-label').textContent = `${appState.mode === 'simple' ? 'Design Tokens' : 'Selected Tokens'} Ready to Export`;
            
            ['color', 'text', 'number', 'states'].forEach(type => {
                const statEl = DOMElements.tokenSummaryCard.querySelector(`[data-type="${type}"]`);
                if (statEl) {
                    const count = appState.globalTokenCounts[type] || 0;
                    const isActive = appState.selectedTokenTypes.has(type);
                    statEl.querySelector('.count').textContent = count;
                    statEl.classList.toggle('active', isActive);
                    statEl.classList.toggle('disabled', count === 0);
                }
            });
        }

        function updateExportCard() {
            const selectedTokenCount = appState.mode === 'simple' 
                ? Object.values(appState.globalTokenCounts).reduce((s, c) => s + c, 0)
                : appState.collections.reduce((count, col) => {
                    if (!appState.selectedCollections.has(col.id)) return count;
                    return count + Object.entries(col.counts).reduce((subCount, [type, num]) => appState.selectedTokenTypes.has(type) ? subCount + num : subCount, 0);
                }, 0);

            const exportBtn = DOMElements.exportCard.querySelector('#export-btn');
            exportBtn.disabled = selectedTokenCount === 0;
            exportBtn.innerHTML = `<i data-lucide="package-check"></i> Export ${selectedTokenCount} Token${selectedTokenCount !== 1 ? 's' : ''}`;

            const select = DOMElements.exportCard.querySelector('#format-select');
            select.value = appState.selectedFormat;
        }

        function updateCollectionsCard() {
            if (appState.mode !== 'advanced') {
                DOMElements.collectionsCard.style.display = 'none';
                return;
            }
            DOMElements.collectionsCard.style.display = 'block';

            const list = DOMElements.collectionsCard.querySelector('.collection-list');
            const filteredCollections = appState.collections.filter(c => c.name.toLowerCase().includes(appState.searchTerm || ''));
            
            list.innerHTML = filteredCollections.map(c => {
                const isSelected = appState.selectedCollections.has(c.id);
                const pillsHTML = Object.entries(c.counts).map(([type, count]) => {
                    if (count === 0) return '';
                    const iconMap = { color: 'palette', text: 'type', states: 'toggle-right', number: 'hash' };
                    return `<div class="collection-pill ${type} ${!appState.selectedTokenTypes.has(type) ? 'disabled' : ''}"><i data-lucide="${iconMap[type]}"></i> <span>${count}</span></div>`;
                }).join('');

                return `
                    <div class="collection-item ${isSelected ? 'selected' : ''}" data-collection-id="${c.id}">
                        <div class="collection-checkbox"></div>
                        <div class="collection-info">
                            <div class="text-body-lg collection-name">${c.name}</div>
                            <div class="collection-pills">${pillsHTML}</div>
                        </div>
                        <div class="text-caption collection-count">${c.totalVariables} tokens</div>
                    </div>`;
            }).join('');
        }

        function updateToggleContainer() {
            if (appState.mode === 'simple') {
                DOMElements.advancedToggleContainer.innerHTML = `<a href="#" class="advanced-link text-body-md" id="toggle-advanced">Customize Your Export <i data-lucide="arrow-right"></i></a>`;
            } else {
                DOMElements.advancedToggleContainer.innerHTML = `<button class="btn secondary" id="toggle-simple"><i data-lucide="arrow-left"></i> Back to Simple Export</button>`;
            }
        }

        // --- EVENT HANDLERS ---
        const debouncedUpdate = debounce(() => updateUI(), 250);

        function attachEventListeners() {
            // Static listeners that only need to be attached once
            DOMElements.aboutLink.onclick = (e) => {
                e.preventDefault();
                DOMElements.aboutModal.style.display = 'flex';
                setTimeout(() => DOMElements.aboutModal.classList.add('show'), 10);
                renderIcons();
            };
            DOMElements.aboutModal.onclick = (e) => {
                if (e.target.closest('.about-close') || e.target === DOMElements.aboutModal) {
                    DOMElements.aboutModal.classList.remove('show');
                    setTimeout(() => DOMElements.aboutModal.style.display = 'none', 300);
                }
            };
            DOMElements.aboutModal.querySelectorAll('.about-link').forEach(link => {
                link.onclick = (e) => {
                    e.preventDefault();
                    openUrl(link.dataset.url);
                };
            });
            
            // Event delegation for dynamic content
            document.body.addEventListener('click', (e) => {
                const exportBtn = e.target.closest('#export-btn');
                const toggleAdvanced = e.target.closest('#toggle-advanced');
                const toggleSimple = e.target.closest('#toggle-simple');
                const collectionItem = e.target.closest('.collection-item');
                const tokenTypeStat = e.target.closest('.token-type-stat:not(.disabled)');
                const emptyAction = e.target.closest('.empty-state-action');

                if (exportBtn) handleExport();
                if (toggleAdvanced) { e.preventDefault(); appState.mode = 'advanced'; updateUI(); }
                if (toggleSimple) { appState.mode = 'simple'; updateUI(); }
                if (collectionItem && appState.mode === 'advanced') {
                    const id = collectionItem.dataset.collectionId;
                    appState.selectedCollections.has(id) ? appState.selectedCollections.delete(id) : appState.selectedCollections.add(id);
                    updateUI();
                }
                if (tokenTypeStat && appState.mode === 'advanced') {
                    const type = tokenTypeStat.dataset.type;
                    appState.selectedTokenTypes.has(type) ? appState.selectedTokenTypes.delete(type) : appState.selectedTokenTypes.add(type);
                    updateUI();
                }
                if (emptyAction) {
                    openUrl('https://help.figma.com/hc/en-us/articles/360041085694-Create-and-use-variables');
                }
            });

            document.body.addEventListener('change', (e) => {
                if (e.target.id === 'format-select') {
                    appState.selectedFormat = e.target.value;
                }
            });

            document.body.addEventListener('input', (e) => {
                if (e.target.id === 'collection-search') {
                    appState.searchTerm = e.target.value;
                    debouncedUpdate();
                }
            });
        }

        // --- EXPORT & PROGRESS ---
        function handleExport() {
            const collectionIds = appState.mode === 'simple' ? appState.collections.map(c => c.id) : Array.from(appState.selectedCollections);
            const tokenTypes = Array.from(appState.selectedTokenTypes);
            if (collectionIds.length === 0 || tokenTypes.length === 0) return;
            const formats = appState.selectedFormat === 'all' ? ['css', 'swift', 'android', 'flutter', 'w3c', 'tailwind'] : [appState.selectedFormat];
            showProgress('Analyzing tokens...');
            parent.postMessage({ pluginMessage: { type: 'export-tokens', collectionIds, formats, activeTokenTypes: tokenTypes } }, '*');
        }
        function showProgress(message) {
            DOMElements.progressOverlay.style.display = 'flex';
            DOMElements.progressOverlay.innerHTML = `<div class="progress-container"><div class="text-heading-md success-title">${message}</div><p class="text-body-md success-subtitle">Please wait while your tokens are packaged.</p></div>`;
        }
        function showSuccessState(data) {
            if (!data || data.length === 0) { showErrorState('No tokens matched your selected criteria.'); return; }
            DOMElements.progressOverlay.innerHTML = `<div class="progress-container"><i data-lucide="check-circle-2" class="success-icon" style="width: 48px; height: 48px;"></i><h2 class="text-heading-md success-title">Export Complete!</h2><p class="text-body-md success-subtitle">Your design tokens are ready.</p><div class="action-buttons"><button class="btn primary" id="save-btn"><i data-lucide="download"></i> Download Your Files</button><button class="btn secondary" id="close-progress-btn"><i data-lucide="x"></i> Close</button></div></div>`;
            renderIcons();
            DOMElements.progressOverlay.querySelector('#save-btn').onclick = () => triggerSave(data);
            DOMElements.progressOverlay.querySelector('#close-progress-btn').onclick = hideProgress;
        }
        function showErrorState(message) {
            DOMElements.progressOverlay.style.display = 'flex';
            DOMElements.progressOverlay.innerHTML = `<div class="progress-container"><i data-lucide="alert-triangle" class="success-icon" style="color:var(--color-text-error); width: 48px; height: 48px;"></i><h2 class="text-heading-md success-title">Export Failed</h2><p class="text-body-md success-subtitle">${message}</p><div class="action-buttons"><button class="btn primary" id="close-progress-btn">Try Again</button></div></div>`;
            renderIcons();
            DOMElements.progressOverlay.querySelector('#close-progress-btn').onclick = hideProgress;
        }
        function triggerSave(data) {
            const link = document.createElement('a');
            if (data.length === 1) {
                const blob = new Blob([data[0].content], { type: 'text/plain;charset=utf-8' });
                link.href = URL.createObjectURL(blob);
                link.download = data[0].filename;
            } else {
                const zip = new JSZip();
                data.forEach(file => zip.file(file.filename, file.content));
                zip.generateAsync({ type: 'blob' }).then(blob => {
                    link.href = URL.createObjectURL(blob);
                    link.download = 'design-tokens.zip';
                    link.click();
                    URL.revokeObjectURL(link.href);
                });
                return;
            }
            link.click();
            URL.revokeObjectURL(link.href);
            hideProgress();
        }
        function hideProgress() { DOMElements.progressOverlay.style.display = 'none'; }

        // --- INITIALIZATION ---
        function initialize() {
            attachEventListeners();
            parent.postMessage({ pluginMessage: { type: 'get-collections' } }, '*');
        }

        window.onmessage = (event) => {
            const msg = event.data.pluginMessage;
            if (!msg) return;
            switch (msg.type) {
                case 'all-collections':
                    DOMElements.skeletonLoader.style.display = 'none';
                    appState.collections = msg.collections || [];
                    if (appState.collections.length === 0) {
                        DOMElements.emptyState.style.display = 'flex';
                    } else {
                        DOMElements.mainUI.style.display = 'block';
                        appState.globalTokenCounts = msg.globalCounts || { color: 0, text: 0, states: 0, number: 0 };
                        appState.selectedTokenTypes = new Set(Object.keys(appState.globalTokenCounts).filter(k => appState.globalTokenCounts[k] > 0));
                        appState.selectedCollections = new Set(appState.collections.map(c => c.id));
                        updateUI();
                    }
                    renderIcons();
                    break;
                case 'export-result':
                    showSuccessState(msg.data);
                    break;
                case 'notify':
                    if (msg.error) showErrorState(msg.message);
                    break;
            }
        };

        // Wait for the DOM to be fully ready before initializing
        document.addEventListener('DOMContentLoaded', initialize);
    </script>
</body>
</html>
