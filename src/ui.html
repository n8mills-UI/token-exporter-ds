<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Token Exporter</title>
    
    <!-- External Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lucide@latest/dist/umd/lucide.js"></script>
    
    <!-- 
      INLINE CRITICAL CSS FOR PLUGIN RELIABILITY
      This uses the fully updated design-system.css (v3.2.0)
    -->
    <style>
        /* Critical CSS from design-system.css v3.2.0 - Plugin Only */
        @import "https://unpkg.com/open-props/normalize";
        
        :root {
            /* Brand Colors */
            --brand-primary-lime: #D2FF37;
            --brand-secondary-yellow: #EEFF00;
            --brand-text-dark: #1E1E1E;
            --brand-gradient-lime: linear-gradient(180deg, #D2FF37 0%, #EEFF00 100%);
            
            /* Token Category Colors */
            --category-color-cyan: #00D1FF;
            --category-color-purple: #B48CFF;
            --category-color-orange: #FFB86C;
            --category-color-pink: #FF74BC;
            
            /* Grays */
            --gray-9: #1e1e1e;
            --gray-8: #2a2a2a;
            --gray-7: #3a3a3a;
            --gray-6: #444444;
            --gray-5: #666666;
            --gray-4: #999999;
            --gray-3: #a0a0a0;
            --gray-2: #cccccc;
            --gray-1: #f0f0f0;
            --gray-0: #ffffff;
            
            /* Semantic colors */
            --color-text-default: var(--gray-0);
            --color-text-secondary: var(--gray-2);
            --color-text-muted: var(--gray-3);
            --color-text-on-brand: var(--brand-text-dark);
            --color-text-error: #ff6b6b;
            
            --color-background-primary: var(--gray-9);
            --color-background-secondary: var(--gray-8);
            --color-background-tertiary: var(--gray-7);
            --color-background-disabled: #333333;
            
            --color-border-default: var(--gray-6);
            --color-border-interactive-focus: var(--brand-primary-lime);
            
            /* Fonts */
            --font-sans: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            --font-mono: 'Monaco', 'Menlo', monospace;
            
            /* Open Props overrides for plugin */
            --surface-1: var(--gray-9);
            --surface-2: var(--gray-8);
            --surface-3: var(--gray-7);
            --surface-4: var(--gray-6);
            
            /* Sizes */
            --size-1: 0.25rem;
            --size-2: 0.5rem;
            --size-3: 0.75rem;
            --size-4: 1rem;
            --size-5: 1.25rem;
            --size-6: 1.5rem;
            --size-7: 1.75rem;
            --size-8: 2rem;
            --size-9: 2.25rem;
            --size-10: 2.5rem;
            --size-11: 3rem;
            --size-12: 3.5rem;
            --size-13: 4rem;
            --size-14: 5rem;
            --size-15: 6rem;
            --size-16: 8rem;
            
            /* Radius */
            --radius-1: 0.125rem;
            --radius-2: 0.375rem;
            --radius-3: 0.5rem;
            --radius-4: 1rem;
            --radius-round: 9999px;
            
            /* Shadows */
            --shadow-1: 0 1px 2px 0 rgb(0 0 0 / .05);
            --shadow-2: 0 1px 3px 0 rgb(0 0 0 / .1), 0 1px 2px -1px rgb(0 0 0 / .1);
            --shadow-3: 0 4px 6px -1px rgb(0 0 0 / .1), 0 2px 4px -2px rgb(0 0 0 / .1);
            --shadow-4: 0 10px 15px -3px rgb(0 0 0 / .1), 0 4px 6px -4px rgb(0 0 0 / .1);
            --shadow-5: 0 20px 25px -5px rgb(0 0 0 / .1), 0 8px 10px -6px rgb(0 0 0 / .1);
            
            /* Font sizes */
            --font-size-00: .5rem;
            --font-size-0: .75rem;
            --font-size-1: 1rem;
            --font-size-2: 1.1rem;
            --font-size-3: 1.25rem;
            --font-size-4: 1.5rem;
            --font-size-5: 2rem;
            --font-size-6: 2.5rem;
            --font-size-7: 3rem;
            --font-size-8: 3.5rem;
            
            /* Font weights */
            --font-weight-1: 100;
            --font-weight-2: 200;
            --font-weight-3: 300;
            --font-weight-4: 400;
            --font-weight-5: 500;
            --font-weight-6: 600;
            --font-weight-7: 700;
            --font-weight-8: 800;
            --font-weight-9: 900;
            
            /* Line heights */
            --font-lineheight-00: .95;
            --font-lineheight-0: 1.1;
            --font-lineheight-1: 1.25;
            --font-lineheight-2: 1.375;
            --font-lineheight-3: 1.5;
            --font-lineheight-4: 1.75;
            --font-lineheight-5: 2;
            
            /* Letter spacing */
            --font-letterspacing-0: -.05em;
            --font-letterspacing-1: .025em;
            --font-letterspacing-2: .05em;
            --font-letterspacing-3: .075em;
            --font-letterspacing-4: .15em;
            --font-letterspacing-5: .5em;
            --font-letterspacing-6: .75em;
            --font-letterspacing-7: 1em;
            
            /* Base Icon Styles for Lucide */
            .lucide {
                width: 1em;
                height: 1em;
                stroke-width: 2.5px;
                vertical-align: middle;
                color: inherit; /* Inherit color from parent by default */
            }

            .btn .lucide, .btn-icon-only .lucide { width: 1.2em; height: 1.2em; transform: translateY(1px); }
            .empty-state-icon .lucide { width: var(--font-size-5); height: var(--font-size-5); }
            .token-type-stat .icon.lucide { width: var(--font-size-3); height: var(--font-size-3); }
            .collection-pill .lucide { width: 12px; height: 12px; }
            .section-title .lucide { color: var(--brand-primary-lime); }
            .about-link .lucide { width: 24px; height: 24px; }

            /* Fix the gradient-7 issue */
            --gradient-7: linear-gradient(135deg, var(--gray-9), var(--gray-8));
        }
        
        /* Base styles */
        html, body {
            color: var(--color-text-default);
            background-color: var(--color-background-primary);
            font-family: var(--font-sans);
            font-size: 14px;
            line-height: 1.5;
            margin: 0;
            padding: 0;
        }
        
        * {
            box-sizing: border-box;
        }
        
        /* Typography */
        .text-heading-xl { 
            font-size: var(--font-size-7);
            font-weight: var(--font-weight-7); 
            line-height: var(--font-lineheight-1);
        }
        
        .text-heading-lg { 
            font-size: var(--font-size-5);
            font-weight: var(--font-weight-6); 
            line-height: var(--font-lineheight-2);
        }
        
        .text-heading-md { 
            font-size: var(--font-size-3);
            font-weight: var(--font-weight-6); 
            line-height: var(--font-lineheight-3);
        }
        
        .text-body-lg { 
            font-size: var(--font-size-2);
            font-weight: var(--font-weight-5); 
            line-height: var(--font-lineheight-3);
        }
        
        .text-body-md { 
            font-size: var(--font-size-1);
            font-weight: var(--font-weight-4); 
            line-height: var(--font-lineheight-3);
        }
        
        .text-label { 
            font-size: var(--font-size-0);
            font-weight: var(--font-weight-6); 
            text-transform: uppercase; 
            letter-spacing: var(--font-letterspacing-2);
        }
        
        .text-caption { 
            font-size: var(--font-size-00);
            font-weight: var(--font-weight-5);
        }
        
        /* Layout */
        main { 
            display: flex; 
            flex-direction: column; 
            position: relative; 
            min-height: 100vh;
        }
        
        .content-wrapper { 
            padding: var(--size-3); 
            flex-grow: 1; 
            overflow-y: auto;
        }
        
        /* Card */
        .card {
            background: var(--color-background-secondary);
            border-radius: var(--radius-3);
            padding: var(--size-3);
            margin-bottom: var(--size-2);
            box-shadow: var(--shadow-2);
            border: 1px solid var(--color-border-default);
        }
        
        /* Token Summary */
        .token-summary { 
            text-align: center; 
            padding: var(--size-6) var(--size-4);
        }
        
        .token-summary .token-count-total { 
            color: var(--brand-primary-lime); 
            margin-bottom: var(--size-1);
        }
        
        .token-summary .token-label { 
            color: var(--color-text-muted); 
            margin-bottom: var(--size-4);
        }
        
        .token-breakdown { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); 
            gap: var(--size-2); 
            border-top: 1px solid var(--gray-8);
            padding-top: var(--size-4);
        }
        
        .token-type-stat {
            text-align: center; 
            transition: all 0.2s ease-in-out;
            cursor: default;
            padding: var(--size-2);
            border-radius: var(--radius-2);
            background: var(--surface-2);
            border: 1px solid transparent;
            min-height: 60px;
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center;
        }
        
        .token-type-stat .icon { 
            margin-bottom: var(--size-1);
            transition: transform 0.2s ease-in-out;
            display: block;
        }
        
        .token-type-stat .count { 
            font-size: var(--font-size-2);
            font-weight: var(--font-weight-6); 
            margin-bottom: var(--size-1);
        }
        
        /* Token type colors */
        .token-type-stat.color .icon { color: var(--category-color-cyan); }
        .token-type-stat.text .icon { color: var(--category-color-purple); }
        .token-type-stat.states .icon { color: var(--category-color-pink); }
        .token-type-stat.number .icon { color: var(--category-color-orange); }
        
        /* Advanced mode */
        .advanced-mode .token-type-stat { cursor: pointer; will-change: transform; }
        .advanced-mode .token-type-stat:hover { 
            background: var(--surface-3);
            border-color: var(--gray-5);
        }
        .advanced-mode .token-type-stat:hover .icon { transform: scale(1.1); }
        .advanced-mode .token-type-stat.active { 
            background: rgba(210, 255, 55, 0.1);
            border-color: var(--brand-primary-lime);
        }
        .advanced-mode .token-type-stat.disabled { 
            opacity: 0.4; 
            cursor: not-allowed;
        }
        
        /* Export Section */
        .section-title { 
            margin-bottom: var(--size-3); 
            display: flex; 
            align-items: center; 
            gap: var(--size-2);
        }
        
        .subtitle { 
            color: var(--color-text-muted); 
            margin-bottom: var(--size-4);
        }
        
        /* Forms */
        .format-select-wrapper { 
            position: relative; 
            margin-bottom: var(--size-4);
        }
        
        .format-select {
            width: 100%; 
            padding: var(--size-3) var(--size-8) var(--size-3) var(--size-4);
            background: var(--color-background-tertiary); 
            border: 1px solid var(--color-border-default); 
            border-radius: var(--radius-2);
            font-weight: var(--font-weight-5);
            cursor: pointer; 
            appearance: none; 
            transition: all 0.2s ease-in-out;
            color: var(--color-text-default);
            font-family: inherit;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
        }
        
        .format-select:hover { 
            background: var(--surface-3);
            border-color: var(--brand-primary-lime);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        .format-select:focus { 
            outline: none; 
            border-color: var(--color-border-interactive-focus); 
            box-shadow: 0 0 0 3px rgba(210, 255, 55, 0.2);
            background: var(--color-background-secondary);
        }
        
        .format-select-wrapper::after {
            content: '';
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%23a0a0a0' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='m6 9 6 6 6-6'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: center;
            width: 1em;
            height: 1em;
            position: absolute; 
            right: var(--size-4); 
            top: 50%; 
            transform: translateY(-50%);
            pointer-events: none; 
            transition: all 0.2s ease-in-out;
            font-size: var(--font-size-1);
        }
        
        /* Buttons */
        .btn {
            width: 100%; 
            padding: var(--size-2) var(--size-3);
            border-radius: var(--radius-2);
            font-weight: var(--font-weight-6); 
            cursor: pointer; 
            transition: all 0.2s ease-in-out;
            border: none; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: var(--size-2);
            position: relative; 
            overflow: hidden;
            font-family: inherit;
            font-size: var(--font-size-1);
            will-change: transform, filter, box-shadow;
        }
        
        .btn::before {
            content: ''; 
            position: absolute; 
            top: 0; 
            left: -100%; 
            width: 100%; 
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transition: left 0.5s ease-in-out;
        }
        
        .btn:hover:not(:disabled)::before { 
            left: 100%; 
        }
        
        .btn.primary { 
            background: var(--brand-gradient-lime); 
            color: var(--color-text-on-brand); 
            box-shadow: 0 4px 15px rgba(210, 255, 55, 0.15);
        }
        
        .btn.primary:hover:not(:disabled) {
            filter: brightness(1.1);
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(210, 255, 55, 0.25);
        }
        
        .btn.secondary { 
            background: var(--color-background-secondary); 
            border: 1px solid var(--color-border-default);
            color: var(--color-text-default);
        }
        
        .btn.secondary:hover:not(:disabled) { 
            background: var(--color-background-tertiary); 
            border-color: var(--gray-5);
            transform: translateY(-1px);
        }
        
        .btn.tertiary {
            background: transparent;
            color: var(--brand-primary-lime);
            border: none;
            padding: var(--size-2) var(--size-3);
            font-weight: var(--font-weight-5);
        }
        
        .btn.tertiary:hover:not(:disabled) {
            background: rgba(210, 255, 55, 0.1);
            transform: translateY(-1px);
        }
        
        .btn:disabled { 
            background: var(--color-background-disabled); 
            color: var(--gray-5); 
            cursor: not-allowed;
            transform: none;
            filter: none;
            box-shadow: none;
            opacity: 0.6;
        }
        
        .btn:disabled::before {
            display: none;
        }
        
        /* Icon-only Button */
        .btn-icon-only {
            width: var(--size-8);
            height: var(--size-8);
            padding: 0;
            border-radius: 50%;
            border: 1px solid var(--color-border-default);
            background: transparent;
            color: var(--color-text-muted);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            will-change: color, border-color, background;
        }
        
        .btn-icon-only:hover {
            color: var(--brand-primary-lime);
            border-color: var(--brand-primary-lime);
            background: rgba(210, 255, 55, 0.1);
        }
        
        /* Collection Items */
        .collection-list {
            display: flex;
            flex-direction: column;
            gap: var(--size-2);
            max-height: 300px;
            overflow-y: auto;
            padding-right: var(--size-1);
        }
        
        .collection-item {
            padding: var(--size-2);
            background: var(--color-background-secondary);
            border: 1px solid var(--color-border-default);
            border-radius: var(--radius-2);
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            display: flex;
            align-items: center;
            gap: var(--size-3);
            position: relative;
            min-height: 48px;
        }
        
        .collection-item:hover {
            background: var(--color-background-tertiary);
            border-color: var(--gray-5);
        }
        
        .collection-item.selected {
            background: rgba(210, 255, 55, 0.05);
            border-color: var(--brand-primary-lime);
        }
        
        .collection-checkbox {
            width: 14px;
            height: 14px;
            border: 2px solid var(--color-border-default);
            border-radius: var(--radius-1);
            position: relative;
            transition: all 0.2s ease-in-out;
            flex-shrink: 0;
            pointer-events: none; /* Let parent handle click */
        }
        
        .collection-item.selected .collection-checkbox {
            background: var(--brand-gradient-lime);
            border-color: var(--brand-primary-lime);
        }
        
        .collection-item.selected .collection-checkbox::after {
            content: '';
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%231E1E1E' stroke-width='3' stroke-linecap='round' stroke-linejoin='round' class='lucide lucide-check'%3E%3Cpath d='M20 6 9 17l-5-5'/%3E%3C/svg%3E");
            width: 10px;
            height: 10px;
            background-size: contain;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        
        .collection-info {
            flex-grow: 1;
            min-width: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        .collection-name {
            font-weight: var(--font-weight-5);
            margin-bottom: var(--size-1);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .collection-count {
            color: var(--color-text-secondary);
            flex-shrink: 0;
        }
        
        .collection-pills {
            display: flex;
            gap: var(--size-1);
            flex-wrap: wrap;
            margin-top: var(--size-1);
        }
        
        .collection-pill {
            display: inline-flex;
            align-items: center;
            gap: var(--size-1);
            padding: var(--size-1);
            border-radius: var(--radius-1);
            font-size: var(--font-size-00);
            font-weight: var(--font-weight-5);
            transition: all 0.2s ease-in-out;
        }
        
        .collection-pill.color {
            background: rgba(0, 209, 255, 0.1);
            color: var(--category-color-cyan);
        }
        
        .collection-pill.text {
            background: rgba(180, 140, 255, 0.1);
            color: var(--category-color-purple);
        }
        
        .collection-pill.number {
            background: rgba(255, 184, 108, 0.1);
            color: var(--category-color-orange);
        }
        
        .collection-pill.states {
            background: rgba(255, 116, 188, 0.1);
            color: var(--category-color-pink);
        }
        
        .collection-pill.disabled {
            opacity: 0.5;
        }
        
        /* Progress & Success States */
        .progress-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: var(--size-6);
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
        }
        
        .progress-container {
            background: var(--color-background-secondary);
            border: 1px solid var(--color-border-default);
            border-radius: var(--radius-3);
            padding: var(--size-4);
            text-align: center;
            max-width: 280px;
            width: 90%;
            will-change: transform;
        }
        
        .success-icon {
            color: var(--brand-primary-lime);
            margin-bottom: var(--size-3);
            filter: drop-shadow(0 0 15px rgba(210, 255, 55, 0.4));
            animation: successPop 0.6s ease-out;
        }
        
        .success-title {
            margin-bottom: var(--size-2);
        }
        
        .success-subtitle {
            color: var(--color-text-secondary);
            margin-bottom: var(--size-5);
        }
        
        .action-buttons {
            display: flex;
            gap: var(--size-3);
            flex-direction: column;
        }
        
        /* Empty State */
        .empty-state {
            background: var(--gradient-7);
            border: 1px dashed rgba(210, 255, 55, 0.2);
            border-radius: var(--radius-3);
            padding: var(--size-8) var(--size-4);
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--size-4);
            min-height: 240px;
            justify-content: center;
        }
        
        .empty-state-icon {
            width: var(--size-10);
            height: var(--size-10);
            background: rgba(210, 255, 55, 0.1);
            border-radius: var(--radius-round);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--brand-primary-lime);
            margin-bottom: var(--size-2);
        }
        
        .empty-state-title {
            font-weight: var(--font-weight-5);
            margin-bottom: var(--size-1);
        }
        
        .empty-state-subtitle {
            color: var(--color-text-secondary);
            max-width: 280px;
            line-height: var(--font-lineheight-3);
        }
        
        .empty-state-action {
            color: var(--brand-primary-lime);
            text-decoration: none;
            font-weight: var(--font-weight-5);
            display: inline-flex;
            align-items: center;
            gap: var(--size-2);
            transition: all 0.2s ease-in-out;
            padding: var(--size-2) var(--size-3);
            border-radius: var(--radius-2);
            border: 1px solid transparent;
        }
        
        .empty-state-action:hover {
            background: rgba(210, 255, 55, 0.1);
            border-color: var(--brand-primary-lime);
            transform: translateY(-1px);
        }
        
        /* Skeleton Loading */
        .skeleton-container {
            display: flex;
            flex-direction: column;
            gap: var(--size-3);
            padding: var(--size-3);
        }
        
        .skeleton-item {
            height: 60px;
            background: var(--gray-8);
            border-radius: var(--radius-3);
            position: relative;
            overflow: hidden;
        }
        
        .skeleton-item.small { 
            height: 40px; 
        }
        
        .skeleton-item:first-child {
            height: 180px;
        }
        
        .skeleton-pulse {
            background: var(--gray-7);
            animation: skeleton-pulse 2s ease-in-out infinite;
        }
        
        @keyframes skeleton-pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }
        
        /* About Modal */
        .about-modal {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            z-index: 1001;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: var(--size-4);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease-in-out;
        }
        
        .about-modal.show {
            opacity: 1;
            visibility: visible;
        }
        
        .about-content {
            background: var(--color-background-secondary);
            border: 1px solid var(--color-border-default);
            border-radius: var(--radius-4);
            padding: var(--size-4);
            max-width: 280px;
            width: 90%;
            text-align: center;
            position: relative;
            display: flex;
            flex-direction: column;
            gap: var(--size-4);
        }
        
        .about-content h2 {
            font-size: var(--font-size-3);
        }
        
        .about-close {
            position: absolute;
            top: var(--size-2);
            right: var(--size-2);
            background: transparent;
            border: none;
            color: var(--color-text-secondary);
            font-size: var(--font-size-2);
            cursor: pointer;
            padding: var(--size-2);
            border-radius: var(--radius-1);
            transition: all 0.2s ease-in-out;
            display: flex;
            align-items: center;
            justify-content: center;
            width: var(--size-8);
            height: var(--size-8);
        }
        
        .about-close:hover {
            background: var(--color-background-tertiary);
        }
        
        .about-avatar {
            width: var(--size-12);
            height: var(--size-12);
            border-radius: var(--radius-round);
            margin: 0 auto;
            background-size: cover;
            background-position: center;
            border: 3px solid var(--brand-primary-lime);
            background-color: var(--gray-7);
            background-image: url('https://res.cloudinary.com/dbmvymdp1/image/upload/v1751613219/nate_mills_nizmxp.png');
        }
        
        .about-header {
            display: flex;
            flex-direction: column;
            gap: var(--size-1);
            padding-bottom: var(--size-3);
            margin-bottom: var(--size-3);
            border-bottom: 1px solid var(--color-border-default);
        }
        
        .about-title {
            color: var(--color-text-secondary);
            font-size: var(--font-size-2);
        }
        
        .about-description {
            color: var(--color-text-secondary);
            line-height: var(--font-lineheight-3);
        }
        
        .about-links {
            display: flex;
            justify-content: center;
            gap: var(--size-2);
        }
        
        .about-link {
            display: flex;
            align-items: center;
            justify-content: center;
            width: var(--size-9);
            height: var(--size-9);
            background: var(--color-background-tertiary);
            border-radius: var(--radius-2);
            color: var(--color-text-secondary);
            text-decoration: none;
            transition: all 0.2s ease-in-out;
            will-change: transform;
        }
        
        .about-link:hover {
            background: var(--brand-primary-lime);
            color: var(--brand-text-dark);
            transform: translateY(-2px);
        }
        
        .about-tagline {
            color: var(--color-text-muted);
            font-size: var(--font-size-00);
        }
        
        .about-tagline .heart {
            color: var(--category-color-pink);
            animation: heartbeat 1.5s ease-in-out infinite;
        }
        
        /* Advanced toggle */
        .advanced-toggle {
            text-align: center;
            margin-top: var(--size-3);
        }
        
        .advanced-link {
            color: var(--color-text-muted);
            text-decoration: none;
            font-weight: var(--font-weight-5);
            transition: color 0.2s ease-in-out;
            display: inline-flex;
            align-items: center;
            gap: var(--size-1);
        }
        
        .advanced-link:hover {
            color: var(--brand-primary-lime);
        }
        
        .advanced-link i {
            font-size: var(--font-size-0);
            transition: transform 0.2s ease-in-out;
        }
        
        .advanced-link:hover i {
            transform: translateX(2px);
        }
        
        /* Footer */
        .footer-section {
            text-align: center;
            line-height: 1.4;
            margin: var(--size-3) 0 0;
            padding: var(--size-3);
            border-top: 1px solid var(--color-border-default);
            margin-top: auto;
        }
        
        .footer-section a {
            color: var(--color-text-muted);
            text-decoration: none;
            transition: all 0.2s ease-in-out;
        }
        
        .footer-section a:hover {
            color: var(--brand-primary-lime);
        }
        
        .footer-section .heart {
            display: inline-block;
            transition: transform 0.3s ease-in-out;
        }
        
        .footer-section a:hover .heart {
            transform: scale(1.2);
        }
        
        /* Scrollbar */
        .content-wrapper::-webkit-scrollbar,
        .collection-list::-webkit-scrollbar { 
            width: var(--size-2); 
        }
        
        .content-wrapper::-webkit-scrollbar-track,
        .collection-list::-webkit-scrollbar-track { 
            background-color: transparent; 
        }
        
        .content-wrapper::-webkit-scrollbar-thumb,
        .collection-list::-webkit-scrollbar-thumb { 
            background-color: var(--gray-6); 
            border-radius: var(--radius-1);
        }
        
        .content-wrapper::-webkit-scrollbar-thumb:hover,
        .collection-list::-webkit-scrollbar-thumb:hover { 
            background-color: var(--gray-5); 
        }
        
        /* Focus States */
        .collection-item:focus-visible,
        .btn:focus-visible,
        .format-select:focus-visible,
        .about-close:focus-visible {
            outline: 2px solid var(--brand-primary-lime);
            outline-offset: 2px;
        }
        
        /* Search Input */
        .search-input {
            width: 100%;
            padding: var(--size-2) var(--size-3) var(--size-2) var(--size-8);
            background: var(--color-background-tertiary);
            border: 1px solid var(--color-border-default);
            border-radius: var(--radius-2);
            font-size: var(--font-size-1);
            transition: all 0.2s ease-in-out;
            color: var(--color-text-default);
            margin-bottom: var(--size-3);
        }
        
        .search-wrapper {
            position: relative;
        }
        
        .search-wrapper .lucide-search {
            position: absolute;
            left: var(--size-3);
            top: 50%;
            transform: translateY(-50%);
            color: var(--color-text-muted);
            pointer-events: none;
        }
        
        .search-input:focus {
            outline: none;
            border-color: var(--color-border-interactive-focus);
            box-shadow: 0 0 0 3px rgba(210, 255, 55, 0.2);
        }
        
        /* Animations */
        @keyframes successPop {
            0% { transform: scale(0) rotate(-180deg); opacity: 0; }
            70% { transform: scale(1.1) rotate(10deg); opacity: 1; }
            100% { transform: scale(1) rotate(0deg); opacity: 1; }
        }
        
        @keyframes heartbeat {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        @keyframes skeleton-pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }

        /* Reduce motion */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
    </style>
    
</head>
<body>
    <main>
        <!-- The main container for dynamic UI content -->
        <div class="content-wrapper" id="content-wrapper">
            <!-- Content will be rendered here by JavaScript -->
        </div>
    </main>

    <!-- The About Modal is static and only needs listeners attached once -->
    <div class="about-modal" id="about-modal">
        <div class="about-content">
            <button class="about-close" aria-label="Close about modal"> <i data-lucide="x"></i> </button>
            <div class="about-avatar"></div>
            <div class="about-header">
                <h2 class="text-heading-md">NATE MILLS</h2>
                <div class="text-body-lg about-title">Senior UI Designer</div>
            </div>
            <p class="text-body-md about-description"> Building accessible design systems that scale, with 20 years of industry experience. </p>
            <div class="about-links">
                <a href="#" class="about-link" data-url="https://natemills.me" title="Portfolio"><i data-lucide="briefcase"></i></a>
                <a href="#" class="about-link" data-url="https://www.linkedin.com/in/millsdesign/" title="LinkedIn"><i data-lucide="linkedin"></i></a>
                <a href="#" class="about-link" data-url="https://www.figma.com/@mills" title="Figma"><i data-lucide="figma"></i></a>
                <a href="#" class="about-link" data-url="mailto:nate@natemills.me" title="Email"><i data-lucide="mail"></i></a>
            </div>
            <div class="text-label about-tagline"> MADE WITH <span class="heart">❤️</span> FOR THE DESIGN COMMUNITY </div>
        </div>
    </div>
    
    <!-- Progress overlay -->
    <div class="progress-overlay" id="progress-overlay" style="display: none;"></div>

    <script>
        // --- STATE MANAGEMENT ---
        const appState = {
            mode: 'simple', collections: [], selectedCollections: new Set(),
            selectedFormat: 'css', selectedTokenTypes: new Set(['color', 'text', 'number', 'states']),
            globalTokenCounts: { color: 0, text: 0, states: 0, number: 0 }, isLoading: true,
            searchTerm: '',
        };

        // --- DOM Elements ---
        const DOMElements = {
            contentWrapper: document.getElementById('content-wrapper'),
            progressOverlay: document.getElementById('progress-overlay'),
            aboutModal: document.getElementById('about-modal'),
        };

        // --- UTILITIES ---
        const openUrl = (url) => parent.postMessage({ pluginMessage: { type: 'open-url', url } }, '*');
        
        const renderIcons = () => {
            try {
                if (window.lucide) {
                    lucide.createIcons();
                }
            } catch (error) {
                console.error("Lucide icon rendering failed:", error);
                // Optionally, post a message back to the plugin to notify about the failure
                parent.postMessage({ pluginMessage: { type: 'notify', message: 'Icon library failed to load.', error: true } }, '*');
            }
        };

        const debounce = (func, delay) => {
            let timeout;
            return function(...args) {
                const context = this;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), delay);
            };
        };

        // --- UI RENDERING (MODULARIZED) ---
        
        function createTokenStat(type, icon, label, count, isActive) {
            const isDisabled = count === 0;
            const li = document.createElement('div');
            li.className = `token-type-stat ${type} ${isActive ? 'active' : ''} ${isDisabled ? 'disabled' : ''}`;
            li.dataset.type = type;
            li.innerHTML = `
                <i data-lucide="${icon}" class="icon"></i>
                <div class="count">${count}</div>
                <div class="text-label label">${label}</div>
            `;
            return li;
        }

        function createCollectionItem(collection) {
            const item = document.createElement('div');
            item.className = `collection-item ${appState.selectedCollections.has(collection.id) ? 'selected' : ''}`;
            item.dataset.collectionId = collection.id;

            const pills = Object.entries(collection.counts)
                .filter(([, count]) => count > 0)
                .map(([type]) => {
                    const iconMap = { color: 'palette', text: 'type', states: 'toggle-right', number: 'hash' };
                    const isDisabled = !appState.selectedTokenTypes.has(type);
                    return `<div class="collection-pill ${type} ${isDisabled ? 'disabled' : ''}">
                                <i data-lucide="${iconMap[type]}"></i> <span>${collection.counts[type]}</span>
                            </div>`;
                }).join('');

            item.innerHTML = `
                <div class="collection-checkbox"></div>
                <div class="collection-info">
                    <div class="text-body-lg collection-name">${collection.name}</div>
                    <div class="collection-pills">${pills}</div>
                </div>
                <div class="text-caption collection-count">${collection.totalVariables} tokens</div>
            `;
            return item;
        }

        function renderUI() {
            const mainContent = document.getElementById('main-content');
            if (!mainContent) return;

            // Clear previous content
            mainContent.innerHTML = '';
            mainContent.className = appState.mode === 'advanced' ? 'advanced-mode' : '';

            if (appState.isLoading) {
                mainContent.innerHTML = `<div class="skeleton-container">
                    <div class="skeleton-item skeleton-pulse"></div>
                    <div class="skeleton-item skeleton-pulse small"></div>
                    <div class="skeleton-item skeleton-pulse small"></div>
                </div>`;
            } else if (appState.collections.length === 0) {
                mainContent.innerHTML = `<div class="empty-state">
                    <div class="empty-state-icon" style="animation: pulse-glow 2s ease-in-out infinite;">
                        <i data-lucide="package-plus"></i>
                    </div>
                    <div>
                        <div class="text-heading-lg empty-state-title">Let's build something!</div>
                        <div class="text-body-md empty-state-subtitle" style="margin-bottom: var(--size-4);">
                            Turn your colors, text styles, and spacing into code-ready tokens.
                        </div>
                    </div>
                    <button class="btn primary empty-state-action" style="width: auto;">
                        Create variables <i data-lucide="arrow-right" style="margin-left: var(--size-2);"></i>
                    </button>
                </div>`;
            } else {
                // Main UI
                const tokenSummaryCard = document.createElement('div');
                tokenSummaryCard.className = 'card token-summary';
                const totalTokens = Object.values(appState.globalTokenCounts).reduce((s, c) => s + c, 0);
                tokenSummaryCard.innerHTML = `<div class="text-label">Design Tokens</div>
                    <div class="text-heading-xl token-count-total">${totalTokens}</div>
                    <div class="text-label token-label">Design Tokens Ready to Export</div>`;
                
                const breakdown = document.createElement('div');
                breakdown.className = 'token-breakdown';
                const tokenTypes = [
                    { type: 'color', icon: 'palette', label: 'colors' }, { type: 'text', icon: 'type', label: 'text' },
                    { type: 'number', icon: 'hash', label: 'numbers' }, { type: 'states', icon: 'toggle-right', label: 'states' }
                ];
                tokenTypes.forEach(({ type, icon, label }) => {
                    const count = appState.globalTokenCounts[type] || 0;
                    const isActive = appState.selectedTokenTypes.has(type);
                    breakdown.appendChild(createTokenStat(type, icon, label, count, isActive));
                });
                tokenSummaryCard.appendChild(breakdown);
                mainContent.appendChild(tokenSummaryCard);

                const exportCard = document.createElement('div');
                exportCard.className = 'card export-section';
                const formats = [
                    { value: 'css', label: 'CSS Variables' }, { value: 'swift', label: 'Swift (iOS)' },
                    { value: 'android', label: 'Android XML' }, { value: 'flutter', label: 'Flutter' },
                    { value: 'w3c', label: 'JSON (W3C)' }, { value: 'tailwind', label: 'Tailwind Config' }
                ];
                exportCard.innerHTML = `<h3 class="text-label section-title"><i data-lucide="rocket"></i> ${appState.mode === 'simple' ? 'Quick Export' : 'Export Options'}</h3>
                    <p class="text-body-md subtitle">Export your tokens in your preferred format</p>
                    <div class="format-select-wrapper">
                        <select class="format-select" id="format-select">
                            <option value="all">All Formats</option>
                            ${formats.map(f => `<option value="${f.value}" ${appState.selectedFormat === f.value ? 'selected' : ''}>${f.label}</option>`).join('')}
                        </select>
                    </div>
                    <button class="btn primary" id="export-btn"></button>`;
                mainContent.appendChild(exportCard);

                const collectionsCard = document.createElement('div');
                collectionsCard.className = 'card collections-section';
                collectionsCard.innerHTML = `<h3 class="text-label section-title"><i data-lucide="layers"></i> Select Collections</h3>`;
                if (appState.collections.length > 5) {
                    collectionsCard.innerHTML += `<div class="search-wrapper"><i data-lucide="search" class="lucide-search"></i><input type="text" class="search-input" placeholder="Search collections..." id="collection-search" value="${appState.searchTerm}"></div>`;
                }
                const collectionList = document.createElement('div');
                collectionList.className = 'collection-list';
                const filteredCollections = appState.collections.filter(c => c.name.toLowerCase().includes(appState.searchTerm.toLowerCase()));
                filteredCollections.forEach(c => collectionList.appendChild(createCollectionItem(c)));
                collectionsCard.appendChild(collectionList);
                mainContent.appendChild(collectionsCard);

                const toggleContainer = document.createElement('div');
                toggleContainer.className = 'advanced-toggle';
                toggleContainer.innerHTML = appState.mode === 'simple'
                    ? `<a href="#" class="advanced-link text-body-md" id="toggle-advanced">Customize Your Export <i data-lucide="arrow-right"></i></a>`
                    : `<button class="btn secondary" id="toggle-simple"><i data-lucide="arrow-left"></i> Back to Simple Export</button>`;
                mainContent.appendChild(toggleContainer);
            }
            
            attachDynamicEventListeners();
            updateExportButton();
            renderIcons();
        }
        
        // --- EVENT HANDLERS ---
        
        function attachStaticEventListeners() {
            document.getElementById('about-link')?.addEventListener('click', e => {
                e.preventDefault();
                DOMElements.aboutModal.classList.add('show');
                renderIcons();
            });

            DOMElements.aboutModal.addEventListener('click', e => { 
                if (e.target.closest('.about-close') || e.target === DOMElements.aboutModal) {
                    DOMElements.aboutModal.classList.remove('show');
                }
            });

            DOMElements.aboutModal.querySelectorAll('.about-link').forEach(link => {
                link.addEventListener('click', e => {
                    e.preventDefault();
                    openUrl(link.dataset.url);
                });
            });
        }
        
        function attachDynamicEventListeners() {
            const mainContent = document.getElementById('main-content');
            if (!mainContent) return;

            mainContent.querySelector('#export-btn')?.addEventListener('click', handleExport);
            
            mainContent.querySelector('#toggle-advanced')?.addEventListener('click', e => {
                e.preventDefault();
                const previousSelections = new Set(appState.selectedCollections);
                appState.mode = 'advanced';
                // Preserve selections if any were made, otherwise select all
                if (previousSelections.size > 0 && previousSelections.size < appState.collections.length) {
                    appState.selectedCollections = previousSelections;
                } else {
                    appState.selectedCollections = new Set(appState.collections.map(c => c.id));
                }
                renderUI();
            });

            mainContent.querySelector('#toggle-simple')?.addEventListener('click', () => {
                appState.mode = 'simple';
                renderUI();
            });
            
            mainContent.querySelectorAll('.collection-item').forEach(item => {
                item.addEventListener('click', () => {
                    const id = item.dataset.collectionId;
                    appState.selectedCollections.has(id) ? appState.selectedCollections.delete(id) : appState.selectedCollections.add(id);
                    renderUI();
                });
            });

            if (appState.mode === 'advanced') {
                mainContent.querySelectorAll('.token-type-stat:not(.disabled)').forEach(stat => {
                    stat.addEventListener('click', () => {
                        const type = stat.dataset.type;
                        appState.selectedTokenTypes.has(type) ? appState.selectedTokenTypes.delete(type) : appState.selectedTokenTypes.add(type);
                        renderUI();
                    });
                });
            }

            mainContent.querySelector('#format-select')?.addEventListener('change', e => { appState.selectedFormat = e.target.value; });
            
            const debouncedRender = debounce(() => renderUI(), 300);
            mainContent.querySelector('#collection-search')?.addEventListener('input', e => {
                appState.searchTerm = e.target.value;
                debouncedRender();
            });

            mainContent.querySelector('.empty-state-action')?.addEventListener('click', () => openUrl('https://help.figma.com/hc/en-us/articles/360041085694-Create-and-use-variables'));
        }

        function updateExportButton() {
            const btn = document.getElementById('export-btn');
            if (!btn) return;
            const selectedCount = appState.mode === 'simple' 
                ? Object.values(appState.globalTokenCounts).reduce((s, c) => s + c, 0)
                : appState.collections.reduce((count, col) => {
                    if (!appState.selectedCollections.has(col.id)) return count;
                    return count + Object.entries(col.counts).reduce((subCount, [type, num]) => appState.selectedTokenTypes.has(type) ? subCount + num : subCount, 0);
                }, 0);
            
            btn.disabled = selectedCount === 0;
            btn.innerHTML = `<i data-lucide="package-check"></i> Export ${selectedCount} Token${selectedCount !== 1 ? 's' : ''}`;
            renderIcons();
        }

        // --- EXPORT & PROGRESS ---
        function handleExport() {
            const collectionIds = appState.mode === 'simple' ? appState.collections.map(c => c.id) : Array.from(appState.selectedCollections);
            const tokenTypes = Array.from(appState.selectedTokenTypes);
            if (collectionIds.length === 0 || tokenTypes.length === 0) return;
            const formats = appState.selectedFormat === 'all' ? ['css', 'swift', 'android', 'flutter', 'w3c', 'tailwind'] : [appState.selectedFormat];
            showProgress('Analyzing tokens...');
            parent.postMessage({ pluginMessage: { type: 'export-tokens', collectionIds, formats, activeTokenTypes: tokenTypes } }, '*');
        }

        function showProgress(message) {
            DOMElements.progressOverlay.style.display = 'flex';
            DOMElements.progressOverlay.innerHTML = `<div class="progress-container">
                <div class="text-heading-md success-title" style="margin-top: var(--size-4);">${message}</div>
                <p class="text-body-md success-subtitle">Please wait while your tokens are packaged.</p>
            </div>`;
            renderIcons();
        }

        function showSuccessState(data) {
            if (!data || data.length === 0) {
                showErrorState('No tokens matched your selected criteria.');
                return;
            }
            DOMElements.progressOverlay.innerHTML = `<div class="progress-container">
                <i data-lucide="check-circle-2" class="success-icon" style="width: 48px; height: 48px;"></i>
                <h2 class="text-heading-md success-title">Export Complete!</h2>
                <p class="text-body-md success-subtitle">Your design tokens are ready.</p>
                <div class="action-buttons">
                    <button class="btn primary" id="save-btn"><i data-lucide="download"></i> Download Your Files</button>
                    <button class="btn secondary" id="close-progress-btn"><i data-lucide="x"></i> Close</button>
                </div>
            </div>`;
            DOMElements.progressOverlay.querySelector('#save-btn').onclick = () => triggerSave(data);
            DOMElements.progressOverlay.querySelector('#close-progress-btn').onclick = hideProgress;
            renderIcons();
        }

        function showErrorState(message) {
            DOMElements.progressOverlay.style.display = 'flex';
            DOMElements.progressOverlay.innerHTML = `<div class="progress-container">
                <i data-lucide="alert-triangle" class="success-icon" style="color:var(--color-text-error); width: 48px; height: 48px;"></i>
                <h2 class="text-heading-md success-title">Export Failed</h2>
                <p class="text-body-md success-subtitle">${message}</p>
                <div class="action-buttons">
                    <button class="btn primary" id="close-progress-btn">Try Again</button>
                </div>
            </div>`;
            DOMElements.progressOverlay.querySelector('#close-progress-btn').onclick = hideProgress;
            renderIcons();
        }

        function triggerSave(data) {
            const link = document.createElement('a');
            if (data.length === 1) {
                const file = data[0];
                const blob = new Blob([file.content], { type: 'text/plain;charset=utf-8' });
                link.href = URL.createObjectURL(blob);
                link.download = file.filename;
            } else {
                const zip = new JSZip();
                data.forEach(file => zip.file(file.filename, file.content));
                zip.generateAsync({ type: 'blob' }).then(blob => {
                    link.href = URL.createObjectURL(blob);
                    link.download = 'design-tokens.zip';
                    link.click();
                    URL.revokeObjectURL(link.href);
                });
                return;
            }
            link.click();
            URL.revokeObjectURL(link.href);
            hideProgress();
        }

        function hideProgress() {
            DOMElements.progressOverlay.style.display = 'none';
        }

        // --- INITIALIZATION & MESSAGE HANDLING ---
        document.addEventListener('DOMContentLoaded', () => {
            // Initial render structure
            DOMElements.contentWrapper.innerHTML = `
                <div id="main-content"></div>
                <div class="footer-section">
                    <a href="#" id="about-link" class="text-caption">created with <span class="heart">❤️</span> by nate mills</a>
                </div>
            `;
            renderUI(); // Initial render call
            attachStaticEventListeners();
            parent.postMessage({ pluginMessage: { type: 'get-collections' } }, '*');
        });

        window.onmessage = (event) => {
            const msg = event.data.pluginMessage;
            if (!msg) return;
            switch (msg.type) {
                case 'all-collections':
                    appState.isLoading = false;
                    appState.collections = msg.collections || [];
                    appState.globalTokenCounts = msg.globalCounts || { color: 0, text: 0, states: 0, number: 0 };
                    appState.selectedTokenTypes = new Set(Object.keys(appState.globalTokenCounts).filter(k => appState.globalTokenCounts[k] > 0));
                    appState.selectedCollections = new Set(appState.collections.map(c => c.id));
                    renderUI();
                    break;
                case 'export-result':
                    showSuccessState(msg.data);
                    break;
                case 'notify':
                    if (msg.error) showErrorState(msg.message);
                    break;
            }
        };
    </script>
</body>
</html>
