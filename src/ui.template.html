<!-- Consolidated Icon System -->
<!-- @include src/components/icons/_icon-system.html -->
<body class="figma-plugin">
    <main>
        <!-- This is the main content wrapper -->
        <div class="content-wrapper" id="content-wrapper">
            
            <!-- This container will be populated by the script -->
            <div id="main-content-container">
                
                <!-- @include src/components/_skeleton-loader.html -->
                <!-- @include src/components/_empty-state.html -->

                <!-- Main UI (hidden by default) -->
                <div id="main-ui" style="display: none;">
                    <div class="card token-summary" id="token-summary-card">
                        <!-- Token Summary will be injected here by the script -->
                    </div>
                    
                    <!-- Export Card Container -->
                    <div id="export-card-container">
                        <!-- Quick Export View (Simple Mode) -->
                        <div id="quick-export-view">
                            <!-- @include src/components/_quick-export-card.html -->
                        </div>
                        
                        <!-- Advanced Filter View (Advanced Mode) -->
                        <div id="advanced-filter-view" class="state-hidden">
                            <!-- Dynamic content will be injected by JavaScript -->
                        </div>
                    </div>

                </div>
            </div>

            <!-- @include src/components/_plugin-footer.html -->
        </div>
    </main>

    <!-- @include src/components/_about-modal.html -->
    
    <div class="progress-overlay" id="progress-overlay" style="display: none;"></div>

    <script>
        // --- STATE & CONFIG ---
        const appState = {
            mode: 'simple',
            collections: [],
            selectedCollections: new Set(),
            selectedFormat: 'css',
            selectedTokenTypes: new Set(['color', 'text', 'number', 'states']),
            globalTokenCounts: { color: 0, text: 0, states: 0, number: 0 },
        };

        const DOMElements = {
            skeletonLoader: document.getElementById('skeleton-loader'),
            emptyState: document.getElementById('empty-state'),
            mainUI: document.getElementById('main-ui'),
            tokenSummaryCard: document.getElementById('token-summary-card'),
            // New stateful elements
            exportCardContainer: document.getElementById('export-card-container'),
            quickExportView: document.getElementById('quick-export-view'),
            advancedFilterView: document.getElementById('advanced-filter-view'),
            // Modals and overlays
            aboutModal: document.getElementById('about-modal'),
            progressOverlay: document.getElementById('progress-overlay'),
            aboutLink: document.getElementById('about-link'),
        };

        // --- UTILITIES ---
        const openUrl = (url) => parent.postMessage({ pluginMessage: { type: 'open-url', url } }, '*');
        const debounce = (func, delay) => {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), delay);
            };
        };
        const renderIcons = () => {
            try {
                console.log('[DEBUG] Rendering icons...');
                // Try both function names for compatibility
                if (window.renderIcons) {
                    window.renderIcons();
                    console.log('[DEBUG] Icons rendered using window.renderIcons');
                } else if (window.renderPluginIcons) {
                    window.renderPluginIcons();
                    console.log('[DEBUG] Icons rendered using window.renderPluginIcons');
                } else {
                    console.warn("Icon rendering function not found");
                }
            } catch (error) {
                console.error("Plugin icon rendering failed:", error);
            }
        };

        // --- UI UPDATE FUNCTIONS ---
        function updateUI() {
            DOMElements.mainUI.classList.toggle('advanced-mode', appState.mode === 'advanced');
            updateTokenSummary();
            updateExportAndCollections(); // Use the new unified function
            renderIcons();
            attachDynamicEventListeners();
        }


function updateTokenSummary() {
    console.log('[DEBUG] Updating token summary...');
    const totalTokens = Object.values(appState.globalTokenCounts).reduce((s, c) => s + c, 0);
    const selectedCount = appState.mode === 'simple' ? totalTokens : appState.collections.reduce((count, col) => {
        if (!appState.selectedCollections.has(col.id)) return count;
        return count + Object.entries(col.counts).reduce((subCount, [type, num]) => appState.selectedTokenTypes.has(type) ? subCount + num : subCount, 0);
    }, 0);

    const tokenLabelText = appState.mode === 'simple' ? 'Tokens Found' : 'Tokens Selected';

    const tokenTypesHTML = ['color', 'text', 'number', 'states'].map(type => {
        const iconMap = { color: 'palette', text: 'type', number: 'hash', states: 'toggle-right' };
        const count = appState.globalTokenCounts[type] || 0;
        const isActive = appState.selectedTokenTypes.has(type);
        return '<div class="token-type-stat ' + type + ' ' + (isActive ? 'active' : '') + ' ' + (count === 0 ? 'disabled' : '') + '" data-type="' + type + '">' +
                '<i class="icon" data-icon="' + iconMap[type] + '"></i>' +
                '<div class="count">' + count + '</div>' +
                '<div class="text-label label" style="color: var(--color-text-muted);">' + type + '</div>' +
            '</div>';
    }).join('');

    console.log('[DEBUG] Token types HTML includes icons:', tokenTypesHTML.includes('data-icon'));
    DOMElements.tokenSummaryCard.innerHTML = 
        '<div class="text-heading-xl token-count-total">' + selectedCount + '</div>' +
        '<div class="text-label token-label">' + tokenLabelText + '</div>' + 
        '<div class="token-breakdown">' + tokenTypesHTML + '</div>';
    console.log('[DEBUG] Token summary updated - icons need re-rendering');
}

                function updateExportAndCollections() {
            const isAdvanced = appState.mode === 'advanced';
            
            // Toggle visibility of the two views
            DOMElements.quickExportView.classList.toggle('state-hidden', isAdvanced);
            DOMElements.advancedFilterView.classList.toggle('state-hidden', !isAdvanced);

            if (isAdvanced) {
                // Build and inject the advanced view content
                const collectionItemsHTML = appState.collections.map(c => {
                    const isSelected = appState.selectedCollections.has(c.id);
                    const pillsHTML = Object.entries(c.counts).map(([type, count]) => {
                        if (count === 0) return '';
                        const iconMap = { color: 'palette', text: 'type', states: 'toggle-right', number: 'hash' };
                        const colorClassMap = { color: 'cyan', text: 'purple', number: 'orange', states: 'pink' };
                        return '<span class="badge small ' + colorClassMap[type] + ' ' + (!appState.selectedTokenTypes.has(type) ? 'disabled' : '') + '"><i class="icon" data-icon="' + iconMap[type] + '"></i> ' + count + '</span>';
                    }).join('');

                    return '<div class="collection-item ' + (isSelected ? 'selected' : '') + '" data-collection-id="' + c.id + '">' +
                        '<div class="collection-checkbox" role="checkbox" aria-checked="' + isSelected + '" tabindex="0" aria-label="Select ' + c.name + ' collection"></div>' +
                        '<div class="collection-info">' +
                            '<div class="text-body-lg collection-name">' + c.name + '</div>' +
                            '<div class="collection-badge-group">' + pillsHTML + '</div>' +
                        '</div>' +
                        '<div class="text-caption collection-count">' + c.totalVariables + ' tokens</div>' +
                    '</div>';
                }).join('');

                DOMElements.advancedFilterView.innerHTML = 
                    '<h3 class="text-label section-title"><i data-icon="sliders-horizontal"></i> Advanced Filtering</h3>' +
                    '<div class="collection-list" style="margin-top: var(--size-3);">' + collectionItemsHTML + '</div>' +
                    '<button class="btn secondary btn-md" id="toggle-simple-mode" style="margin-top: var(--size-3);" aria-label="Return to quick export mode">' +
                        '<i data-icon="arrow-left"></i>' +
                        '<span>Back to Quick Export</span>' +
                    '</button>';
            }
            
            // Always update the export button in the quick export view
            const selectedTokenCount = isAdvanced 
                ? appState.collections.reduce((count, col) => {
                    if (!appState.selectedCollections.has(col.id)) return count;
                    return count + Object.entries(col.counts).reduce((subCount, [type, num]) => appState.selectedTokenTypes.has(type) ? subCount + num : subCount, 0);
                }, 0)
                : Object.values(appState.globalTokenCounts).reduce((s, c) => s + c, 0);

            const exportBtn = document.getElementById('export-btn');
            if (exportBtn) {
                exportBtn.disabled = selectedTokenCount === 0;
                exportBtn.innerHTML = '<i data-icon="rocket"></i> Export ' + selectedTokenCount + ' Token' + (selectedTokenCount !== 1 ? 's' : '');
            }
        }

        // --- EVENT HANDLERS ---
        const debouncedUpdate = debounce(() => updateUI(), 250);

        function attachEventListeners() {
            // Static listeners
            DOMElements.aboutLink.onclick = (e) => {
                e.preventDefault();
                DOMElements.aboutModal.classList.add('show');
                renderIcons();
            };
            DOMElements.aboutModal.onclick = (e) => {
                if (e.target.closest('[data-close-modal]') || e.target.closest('.about-modal-backdrop') || e.target === DOMElements.aboutModal) {
                    DOMElements.aboutModal.classList.remove('show');
                }
            };
            DOMElements.aboutModal.querySelectorAll('.about-link').forEach(link => {
                link.onclick = (e) => {
                    e.preventDefault();
                    openUrl(link.dataset.url);
                };
            });
            // Note: emptyStateAction is now inside a partial, but this should still work
            // as long as the script runs after the DOM is populated.
            const emptyStateAction = document.querySelector('.empty-state-action');
            if (emptyStateAction) {
                emptyStateAction.addEventListener('click', () =>
                    openUrl('https://help.figma.com/hc/en-us/articles/360041085694-Create-and-use-variables')
                );
            }
        }

               function attachDynamicEventListeners() {
            const exportBtn = document.getElementById('export-btn');
            if (exportBtn) exportBtn.onclick = handleExport;

            const toggleAdvanced = document.getElementById('toggle-advanced-mode');
            if (toggleAdvanced) toggleAdvanced.onclick = () => {
                appState.mode = 'advanced';
                updateUI();
            };

            const toggleSimple = document.getElementById('toggle-simple-mode');
            if (toggleSimple) toggleSimple.onclick = () => {
                appState.mode = 'simple';
                updateUI();
            };

            document.querySelectorAll('.collection-item').forEach(item => {
                item.onclick = () => {
                    const id = item.dataset.collectionId;
                    if (appState.mode === 'advanced') {
                        appState.selectedCollections.has(id) ? appState.selectedCollections.delete(id) : appState.selectedCollections.add(id);
                        updateUI();
                    }
                };
            });

            if (appState.mode === 'advanced') {
                document.querySelectorAll('.token-type-stat:not(.disabled)').forEach(stat => {
                    stat.onclick = () => {
                        const type = stat.dataset.type;
                        appState.selectedTokenTypes.has(type) ? appState.selectedTokenTypes.delete(type) : appState.selectedTokenTypes.add(type);
                        updateUI();
                    };
                });
            }

            const formatSelect = document.getElementById('format-select');
            if (formatSelect) formatSelect.onchange = e => {
                appState.selectedFormat = e.target.value;
            };
        }
        
        // --- EXPORT & PROGRESS ---
        function handleExport() {
            const collectionIds = appState.mode === 'simple' ? appState.collections.map(c => c.id) : Array.from(appState.selectedCollections);
            const tokenTypes = Array.from(appState.selectedTokenTypes);
            if (collectionIds.length === 0 || tokenTypes.length === 0) return;
            const formats = appState.selectedFormat === 'all' ? ['css', 'swift', 'android', 'flutter', 'w3c', 'tailwind'] : [appState.selectedFormat];
            
            showProgress();
            
            parent.postMessage({ pluginMessage: { type: 'export-tokens', collectionIds, formats, activeTokenTypes: tokenTypes } }, '*');
        }

        function showProgress() {
            DOMElements.tokenSummaryCard.innerHTML = 
                '<div class="te-progress-loader" id="pluginProgressLoader" style="height: 194px;">' +
                    '<div class="te-icon-grid" id="pluginIconGrid"></div>' +
                    '<div class="te-celebration" id="pluginCelebration"></div>' +
                    '<div class="te-glass-status surface-glass" id="pluginGlassStatus">' +
                        '<p class="te-progress-percent" id="pluginProgressPercent">0%</p>' +
                        '<div class="te-progress-track">' +
                            '<div class="te-progress-fill" id="pluginProgressFill"></div>' +
                        '</div>' +
                        '<p class="te-status-label" id="pluginStatusLabel" aria-live="polite" aria-atomic="true">Warming up</p>' +
                    '</div>' +
                '</div>';
            initializePluginLoader();
        }
        
        function updateProgress(progress) {
            const progressStages = [
                { percent: 25, label: "Analyzing" },
                { percent: 50, label: "Packaging" },
                { percent: 75, label: "Sanitizing" },
                { percent: 95, label: "Finalizing" }
            ];
            
            const percentEl = document.getElementById('pluginProgressPercent');
            const fillEl = document.getElementById('pluginProgressFill');
            const labelEl = document.getElementById('pluginStatusLabel');
            
            if (percentEl) percentEl.textContent = progress + '%';
            if (fillEl) fillEl.style.width = progress + '%';
            
            const currentStage = progressStages.find(s => progress <= s.percent) || progressStages[progressStages.length - 1];
            if (labelEl) labelEl.textContent = currentStage.label;
        }

        function showSuccessState(fileData) {
            const container = document.getElementById('pluginProgressLoader');
            if (!container) {
                updateTokenSummary();
                if (fileData && fileData.length > 0) triggerSave(fileData);
                return;
            }
            
            container.classList.add('te-celebrating');
            const grid = document.getElementById('pluginIconGrid');
            if(grid) grid.classList.add('fade-out');

            const celebrationContainer = document.getElementById('pluginCelebration');
            if(celebrationContainer) {
                const successIcon = document.createElement('div');
                successIcon.className = 'te-success-icon';
                successIcon.innerHTML = '<i data-icon="check-circle"></i>';
                celebrationContainer.appendChild(successIcon);
            }
            
            renderIcons();

            setTimeout(() => {
                updateTokenSummary();
                if (fileData && fileData.length > 0) {
                    triggerSave(fileData);
                }
            }, 2500);
        }
        
        function showErrorState(message) {
            DOMElements.tokenSummaryCard.innerHTML = 
                '<div class="progress-container" style="animation: none; padding: var(--size-4); display:flex; flex-direction:column; align-items:center; justify-content:center; height: 194px; gap: var(--size-2);">' +
                    '<i data-icon="alert-triangle" class="icon icon--xl success-icon" style="color:var(--color-text-error); animation: none; margin-bottom: var(--size-2);"></i>' +
                    '<h2 class="text-heading-md success-title" style="margin-bottom: var(--size-1);">Export Failed</h2>' +
                    '<p class="text-body-md success-subtitle" style="margin-bottom: var(--size-3);">' + message + '</p>' +
                    '<button class="btn secondary btn-inline" id="close-error-btn" aria-label="Close error and try again">Try Again</button>' +
                '</div>';
            renderIcons();
            const closeBtn = document.getElementById('close-error-btn');
            if (closeBtn) closeBtn.onclick = updateTokenSummary;
        }

        function triggerSave(data) {
            const link = document.createElement('a');
            if (data.length === 1) {
                const blob = new Blob([data[0].content], { type: 'text/plain;charset=utf-8' });
                link.href = URL.createObjectURL(blob);
                link.download = data[0].filename;
            } else {
                data.forEach((file, index) => {
                    setTimeout(() => {
                        const fileLink = document.createElement('a');
                        const blob = new Blob([file.content], { type: 'text/plain;charset=utf-8' });
                        fileLink.href = URL.createObjectURL(blob);
                        fileLink.download = file.filename;
                        fileLink.click();
                        URL.revokeObjectURL(fileLink.href);
                    }, index * 300);
                });
                return;
            }
            link.click();
            URL.revokeObjectURL(link.href);
        }

        function initializePluginLoader() {
            const grid = document.getElementById('pluginIconGrid');
            if (!grid) return;
            
            const tokenTypes = [
                { icon: 'palette', color: '--value-color' }, { icon: 'type', color: '--value-text' },
                { icon: 'hash', color: '--value-number' }, { icon: 'toggle-right', color: '--value-state' }
            ];
            
            for (let i = 0; i < 40; i++) {
                const cell = document.createElement('div');
                cell.classList.add('te-icon-cell');
                
                const category = tokenTypes[i % tokenTypes.length];
                const icon = document.createElement('i');
                icon.setAttribute('data-icon', category.icon);
                cell.appendChild(icon);
                cell.style.setProperty('--color', 'var(' + category.color + ')');
                
                const angle = Math.random() * Math.PI * 2;
                const radius = 120 + Math.random() * 40;
                
                cell.style.setProperty('--x-start', Math.cos(angle) * radius + 'px');
                cell.style.setProperty('--y-start', Math.sin(angle) * radius + 'px');
                cell.style.setProperty('--x-end', Math.cos(angle + Math.PI) * radius + 'px');
                cell.style.setProperty('--y-end', Math.sin(angle + Math.PI) * radius + 'px');
                cell.style.setProperty('--delay', Math.random() * 1.5 + 's');
                cell.style.setProperty('--scale', 0.6 + Math.random() * 0.5);
                cell.style.setProperty('--blur', (Math.random() > 0.3) ? '0px' : Math.random() * 2 + 'px');
                
                grid.appendChild(cell);
            }
            renderIcons();
        }

        // --- INITIALIZATION ---
        function initialize() {
            console.log('[DEBUG] Initializing plugin...');
            // Explicitly set the correct initial UI state.
            if (DOMElements.skeletonLoader) {
                DOMElements.skeletonLoader.style.display = 'block';
                console.log('[DEBUG] Skeleton loader visible');
            }
            if (DOMElements.emptyState) DOMElements.emptyState.style.display = 'none';
            if (DOMElements.mainUI) DOMElements.mainUI.style.display = 'none';

            // Render icons for the skeleton loader.
            console.log('[DEBUG] Initial icon render for skeleton loader');
            renderIcons(); 

            // Immediately ask the main plugin for the variable collections.
            console.log('[DEBUG] Requesting collections from plugin...');
            parent.postMessage({ pluginMessage: { type: 'get-collections' } }, '*');

            // Attach all static event listeners.
            attachEventListeners();
        }

        window.onmessage = (event) => {
            const msg = event.data.pluginMessage;
            if (!msg) return;
            switch (msg.type) {
                case 'all-collections':
                    console.log('[DEBUG] Received collections:', msg.collections);
                    DOMElements.skeletonLoader.style.display = 'none';
                    appState.collections = msg.collections || [];
                    if (appState.collections.length === 0) {
                        // If no collections, show the empty state and hide the main UI
                        console.log('[DEBUG] No collections - showing empty state');
                        DOMElements.emptyState.style.display = 'flex';
                        DOMElements.mainUI.style.display = 'none';
                    } else {
                        // If collections exist, show the main UI and hide the empty state
                        console.log('[DEBUG] Collections found - showing main UI');
                        DOMElements.emptyState.style.display = 'none';
                        DOMElements.mainUI.style.display = 'block';
                        appState.globalTokenCounts = msg.globalCounts || { color: 0, text: 0, states: 0, number: 0 };
                        appState.selectedTokenTypes = new Set(Object.keys(appState.globalTokenCounts).filter(k => appState.globalTokenCounts[k] > 0));
                        appState.selectedCollections = new Set(appState.collections.map(c => c.id));
                        updateUI();
                    }
                    console.log('[DEBUG] About to render icons after collections loaded');
                    renderIcons();
                    break;
                case 'export-progress':
                    updateProgress(msg.percent);
                    break;
                case 'export-result':
                    updateProgress(100);
                    setTimeout(() => showSuccessState(msg.data), 500);
                    break;
                case 'notify':
                    if (msg.error) showErrorState(msg.message);
                    break;
            }
        };

        // --- Responsive Height Observer ---
        const resizeObserver = new ResizeObserver(entries => {
            const entry = entries[0];
            // Add a 16px buffer to the height to prevent scrollbars from flashing
            const height = entry.contentRect.height + 16; 
            parent.postMessage({ pluginMessage: { type: 'resize', width: 340, height: Math.round(height) } }, '*');
        });

        // Observe the main content wrapper for size changes
        const contentWrapper = document.getElementById('content-wrapper');
        if (contentWrapper) {
            resizeObserver.observe(contentWrapper);
        }

        document.addEventListener('DOMContentLoaded', initialize);
    </script>
</body>
